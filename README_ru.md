![PeDitX Banner](https://raw.githubusercontent.com/peditx/luci-theme-peditx/refs/heads/main/luasrc/brand.png)
# PeDitX's CoreDNS-master: Advanced DNS Proxy and Bypass Manager
## Language Selection:

[**English**](README.md) | [**فارسی**](README_fa.md) | [**中文**](README_zh.md) | [**Русский**](README_ru.md)


[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/peditx/CoreDNS-master/blob/main/LICENSE)
[![GitHub stars](https://img.shields.io/github/stars/peditx/CoreDNS-master.svg?style=social)](https://github.com/peditx/CoreDNS-master/stargazers)
[![GitHub forks](https://img.shields.io/github/forks/peditx/CoreDNS-master.svg?style=social)](https://github.com/peditx/CoreDNS-master/network/members)


## Обзор проекта

PeDitX's CoreDNS-master — это мощное и гибкое решение для управления DNS-трафиком, разработанное для эффективного обхода интернет-ограничений. Оно объединяет **CoreDNS** в качестве надежного DNS-бэкенда, API на базе **FastAPI** для интеллектуального управления и фронтенд **React.js** для интуитивно понятного пользовательского интерфейса. Эта система позволяет выборочно маршрутизировать DNS, включая такие расширенные функции, как **фильтрация по Geo-IP** и **интеграция прокси Xray** для определенных доменов или географических регионов.

Цель состоит в том, чтобы предоставить комплексное, легко управляемое и масштабируемое решение DNS-прокси для большого числа пользователей, предоставляя вам детальный контроль над путями разрешения DNS.

-----

## Возможности

  * **Бэкенд CoreDNS:** Высокопроизводительное и надежное разрешение DNS.
  * **API бэкенда FastAPI:** Быстрый и современный API для управления всеми конфигурациями DNS.
  * **Фронтенд-интерфейс React.js:** Интуитивно понятный веб-интерфейс для простого управления доменами и правилами.
  * **Обход блокировок на основе доменов:** Маршрутизация определенных доменов через пользовательские DNS-серверы.
  * **Маршрутизация на основе Geo-IP:** Направление DNS-запросов на основе географического положения пользователя с использованием MaxMind GeoLite2.
  * **Маршрутизация на основе Geo-Site:** Применение специфических DNS-правил к спискам доменов, классифицированных по регионам или назначению.
  * **Интеграция прокси Xray:** Бесперебойная маршрутизация DNS-трафика для выбранных доменов или регионов через туннель Xray для расширенного обхода цензуры, управляемая непосредственно из пользовательского интерфейса.
  * **Автоматическое управление конфигурацией:** API динамически генерирует конфигурацию CoreDNS и перезагружает службу.
  * **Простая установка:** Оптимизированный процесс установки и модификации с помощью интерактивных скриптов командной оболочки.

-----

## Архитектура

Проект использует современную трехуровневую архитектуру:

  * **Уровень DNS:** CoreDNS действует как основной DNS-сервер, настроенный для обработки запросов и применения политик маршрутизации на основе инструкций API бэкенда.
  * **Уровень API:** Приложение Python FastAPI служит плоскостью управления. Оно взаимодействует с базой данных PostgreSQL для хранения конфигураций (домены, правила GeoIP, настройки Xray) и динамически обновляет файлы конфигурации CoreDNS. Оно также управляет перезапуском службы Xray.
  * **Уровень представления:** Одностраничное приложение (SPA) на React.js предоставляет удобный веб-интерфейс для администраторов для взаимодействия с API, что упрощает управление сложными правилами маршрутизации.

-----

## Установка

Этот проект использует ряд последовательных скриптов установки и модификации для настройки всей среды на **системах на базе Debian/Ubuntu**.

**Настоятельно рекомендуется следовать шагам установки, чтобы обеспечить плавную настройку.**

### Предварительные требования

Прежде чем начать, убедитесь, что у вас есть:

  * Чистый сервер Debian/Ubuntu (рекомендуется VPS).
  * Root-доступ или пользователь с привилегиями `sudo`.
  * Активное подключение к Интернету на сервере.
  * **(Необязательно, но рекомендуется для Geo-IP):** [Ключ лицензии MaxMind GeoLite2](https://www.maxmind.com/en/geolite2/downloads) для загрузки баз данных GeoIP.
  * **(Необязательно, но рекомендуется для Xray):** Данные вашего удаленного Xray-сервера (IP/домен, порт, UUID, протокол, сеть, настройки TLS).

### Быстрая установка

Чтобы установить все необходимые предварительные требования и запустить главное интерактивное меню, выполните следующую команду:

```bash
rm -f setup.sh && wget https://raw.githubusercontent.com/peditx/CoreDNS-master/refs/heads/main/setup.sh && chmod +x setup.sh && sudo bash setup.sh
```

Эта команда:

1.  Удалит любой существующий файл `setup.sh`.
2.  Загрузит последнюю версию скрипта `setup.sh` из репозитория GitHub.
3.  Предоставит права на выполнение загруженному скрипту.
4.  Выполнит скрипт `setup.sh` с привилегиями `sudo`.

Затем скрипт `setup.sh` выполнит:

  * Обновление вашей системы и установку основных инструментов (curl, wget, git, vim, systemctl и т.д.).
  * Установку **Node.js, npm и `create-react-app`**.
  * Установку **Python3, pip и `python3-venv`**.
  * Установку **PostgreSQL**.
  * Установку **Nginx**.
  * Установку **UFW** (Uncomplicated Firewall) и **ACL**.
  * Наконец, он загрузит и выполнит скрипт `menu.sh`, который предоставляет интерактивный интерфейс для установки и настройки компонентов CoreDNS Bypass Manager.

### Пошаговая установка (через `menu.sh`)

После завершения работы `setup.sh` скрипт `menu.sh` запустится автоматически. Следуйте подсказкам на экране и выбирайте опции в указанном ниже порядке, чтобы полностью настроить вашу систему:

1.  **Установка CoreDNS (install\_coredns.sh):** Настраивает DNS-сервер CoreDNS.
2.  **Установка бэкенда API (install\_api\_backend.sh):** Развертывает приложение FastAPI и настраивает PostgreSQL.
3.  **Установка фронтенд-интерфейса (install\_frontend\_ui.sh):** Настраивает веб-интерфейс React.js и настраивает Nginx для его обслуживания.
4.  **Применение мода Geo-IP (mod\_geo\_ip.sh):** Интегрирует функциональность Geo-IP в API и CoreDNS.
5.  **Интеграция Xray (mod\_xray\_integration.sh):** Устанавливает Xray и настраивает его локальный DNS-прокси, настраивая API для управления Xray.
6.  **Обновление пользовательского интерфейса Xray (update\_xray\_ui\_integration.sh):** Обновляет пользовательский интерфейс для управления конфигурацией Xray, правилами GeoIP и списками GeoSite напрямую.

**Важно:** Каждый скрипт в меню основывается на предыдущем. **Не пропускайте шаги и не запускайте их в неправильном порядке**, если вы полностью не понимаете зависимости.

-----

## Использование

После успешной установки ваш пользовательский интерфейс CoreDNS Bypass Manager будет доступен по IP-адресу или доменному имени вашего сервера на порту Nginx (по умолчанию: 80).

  * **Доступ к пользовательскому интерфейсу:** Откройте веб-браузер и перейдите по адресу `http://YOUR_SERVER_IP` (или `http://YOUR_SERVER_IP:NGINX_PORT`, если вы выбрали нестандартный порт).
  * **Документация API:** Документация Swagger UI для API будет доступна по адресу `http://YOUR_SERVER_IP:API_PORT/docs` (порт API по умолчанию: 8000).

Пользовательский интерфейс предоставляет возможности для:

  * Добавления, редактирования и удаления доменов для обхода блокировок.
  * Настройки правил Geo-IP (по коду страны) для специфической маршрутизации или блокировки.
  * Управления списками Geo-Site с пользовательской маршрутизацией.
  * **Обновления конфигурации Xray:** Предоставьте `config.json` Xray через URL или вставьте напрямую.
  * **Обновления базы данных GeoIP:** Запустите загрузку последней базы данных MaxMind GeoLite2 (требуется ключ лицензии).
  * **Применения изменений CoreDNS:** Примените все конфигурации из базы данных к CoreDNS и перезагрузите его службу.

-----

## Вопросы безопасности

  * **Межсетевой экран:** Убедитесь, что UFW настроен так, чтобы разрешать только необходимые порты (53 для DNS, 80/443 для Nginx, 8000 для доступа к API, 9153 для Prometheus).
  * **Выделенные пользователи:** Скрипты установки пытаются использовать выделенных системных пользователей (`coredns`, `api_user`) для повышения безопасности. Не запускайте службы от имени root в продакшене.
  * **Конфигурация Sudoers:** API требуется доступ `NOPASSWD` sudo для `systemctl reload coredns` и `systemctl restart xray`. Просмотрите и максимально ужесточите эти разрешения для вашей конкретной среды.
  * **Ключ лицензии MaxMind:** Держите свой ключ лицензии MaxMind в секрете.
  * **Конфигурация Xray:** Ваш файл `config.json` Xray содержит конфиденциальную информацию (UUID, данные сервера). Убедитесь, что он защищен и доступен только для API.
  * **Аутентификация API:** Для производственных сред **настоятельно рекомендуется** реализовать аутентификацию API (например, с использованием токенов JWT) для предотвращения несанкционированного доступа к вашей системе управления DNS. Это не включено в базовую настройку для простоты, но имеет решающее значение для безопасности.

-----

## Устранение неполадок

  * **Проверка статуса службы:**
      * `sudo systemctl status coredns`
      * `sudo systemctl status dns_api`
      * `sudo systemctl status xray`
      * `sudo systemctl status nginx`
  * **Просмотр журналов:**
      * `sudo journalctl -u coredns --no-pager`
      * `sudo journalctl -u dns_api --no-pager`
      * `sudo journalctl -u xray --no-pager`
      * `sudo journalctl -u nginx --no-pager`
  * **Проблемы с разрешениями:** Многие проблемы связаны с разрешениями файлов. Убедитесь, что у `api_user` есть права на запись в `/etc/coredns` и `/usr/local/etc/xray`.
  * **Связь с API:** Используйте `curl` для прямого тестирования конечных точек API с сервера, чтобы изолировать проблемы.
  * **Консоль пользовательского интерфейса:** Проверьте консоль разработчика вашего браузера на наличие ошибок JavaScript или проблем с сетью при использовании пользовательского интерфейса.

-----

## Вклад в разработку

Вклад в разработку приветствуется\! Если вы обнаружите ошибки, у вас есть предложения по функциям или вы хотите улучшить код, не стесняйтесь открыть issue или отправить pull request в репозиторий GitHub.

-----

## Лицензия

Этот проект лицензирован по лицензии MIT — см. файл [LICENSE](https://www.google.com/search?q=LICENSE) для получения подробной информации.
